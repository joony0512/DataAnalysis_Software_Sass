# ch4

- proc sql 문 안에 select문을 여러 번 쓸 수 있다.
- 서브쿼리 : select문 안에 또 다른 select문 넣어 작성. 괄호로 묶음
    - correlated
    - Noncorrelated

## Noncorrelated : in, 아니면 비교연산자와 함께 any,all

- 숫자대신에 서브쿼리 쓸 수 있다

```sass
//전체 평균보다 큰 평균(잡코드별)만 뽑기
proc sql;
select JobCode, avg(Salary) as MeanSalary
from a.payrollmaster
group by Jobcode
having avg(Salary) > (select avg(Salary)  from a.payrollmaster ) ;
quit;
```

| JobCode | MeanSalary |
| --- | --- |
| ME3 | 59375 |
| NA1 | 58845.08 |
| NA2 | 88003.44 |
| PT1 | 95071.2 |
| PT2 | 122253.6 |
| PT3 | 154706.3 |
| TA3 | 55551.42 |

# IN

- 서브쿼리 안의 값들이 필요할때 **in** —> 조건에 사용
    - noncorrelated subquery는 가상의 테이블을 먼저 만듬→  =을 쓸 수 없음

```sass
//서브쿼리를 조건으로 쿼리 실행 
//생일은 다른 테이블에 존재하고 있음
//두 테이블 안에 같은 열은 empid임
proc sql;
select LastName, FirstName, City, State
from a.staffmaster
where EmpID in (select EmpID
					from a.payrollmaster
					where month(DateOfBirth)=2);
quit;
```

| LastName | FirstName | City | State |
| --- | --- | --- | --- |
| BOWDEN | EARL | BRIDGEPORT | CT |
| CARTER | DONALD | NEW YORK | NY |
| LONG | RUSSELL | NEW YORK | NY |
| MCDANIEL | RONDA | NEW YORK | NY |
| ROUSE | JEREMY | PATERSON | NJ |
| SMART | JONATHAN | NEW YORK | NY |

# ANY

- any : 가상의 테이블속 값들 중 하나라도 만족하면 되기 때문에 =를 쓸 수 있다

```sass
//any 사용법
proc sql;
select LastName, FirstName, City, State
from a.staffmaster
where EmpID = any (select EmpID
					from a.payrollmaster
					where month(DateOfBirth)=2);
quit;
```

| LastName | FirstName | City | State |
| --- | --- | --- | --- |
| BOWDEN | EARL | BRIDGEPORT | CT |
| CARTER | DONALD | NEW YORK | NY |
| LONG | RUSSELL | NEW YORK | NY |
| MCDANIEL | RONDA | NEW YORK | NY |
| ROUSE | JEREMY | PATERSON | NJ |
| SMART | JONATHAN | NEW YORK | NY |

```sass
// 서브쿼리 안의 내용 중 하나보다라도 작으면 됨  
//  < any = max
proc sql;
select FFID, Name, Milestraveled
from a.frequentflyers
where membertype='GOLD'
and milestraveled < any
						(select milestraveled
						from a.frequentflyers
						where membertype in ('BRONZE', 'SILVER'));
quit;
```

| FFID | Name | MilesTraveled |
| --- | --- | --- |
| WD1576 | BRYANT, ALTON | 56144 |
| WD0646 | BOSTIC, MARIE | 87044 |
| WD9829 | COOK, JENNIFER | 1901 |
| WD0227 | FOSTER, GERALD | 46579 |
| WD3541 | AVERY, JERRY | 70523 |
| WD4451 | EDGERTON, JOSHUA | 19 |
| WD5190 | SAYERS, RANDY | 17848 |
| WD9840 | VANDEUSEN, RICHARD | 42026 |
| WD0273 | WANG, CHRISTOPHER | 71343 |
| WD0231 | GORDON, ANNE | 5446 |

```sass
//all 키워드 사용 any와 반대 : 서브쿼리 안 모든것보다 작음 = min
proc sql;
select FFID, Name, Milestraveled
from a.frequentflyers
where membertype='GOLD'
and milestraveled < all
						(select milestraveled
						from a.frequentflyers
						where membertype in ('BRONZE', 'SILVER'));
quit;
```

FFID	                       Name	 MilesTraveled
WD4451	EDGERTON, JOSHUA	19

- 과제
    
    Create the report for February and list the first and last names of all
    employees who were hired during the month of February of any year.
    You can find employee names in the airline.staffmaster table and
    employee hire dates in the airline.payrollmaster table. Order the
    report by employee last name.
    ▪ Begin by creating the inner query that returns, from the
    airline.payrollmaster table, a list of employee IDs for employees
    with a February anniversary.
    ▪ Combine the inner query with an outer query that selects, from
    airline.staffmaster, the first name and last name of employees
    whose IDs are in the list generated by the inner query. Create an
    appropriate title.
    
    ```sass
    proc sql;
    select FirstName, LastName
    from a.staffmaster
    where EmpID in (select EmpID
    		from a.payrollmaster
    		where month(DateOfHire) =2)
    order by LastName;
    quit;
    ```
    
- any와 all차이
    
    
    | >any | >all |
    | --- | --- |
    | min | max |
    | <any | <all |
    | max | min |

## correlated : 서브쿼리속 맞는지 검증후 조건과 대조 후 입력

```sass
//nonecorrelated와 달리 =를 쓸 수 있다. 행을 한줄씩 가져오기 때문이다.
proc sql;
select LastName, FirstName, State
from a.staffmaster
where 'NA' =
				(select JobCategory
				from a.supervisors
				where staffmaster.EmpID=
						supervisors.EmpID);
quit;

proc sql;
create table fa as 
select *
from a.staffmaster, a.fa
where staffmaster.lastname = fa.lastname & staffmaster.firstname=fa.firstname;
quit;

proc sql;
select lastname, firstname
from work.fa
where not exists
(select *
from a.flightschedule
where fa.EmpID = flightschedule.EmpID);
quit;
```

- 과제2
    
    Create a report that shows the number of flights that are domestic
    flights of the march flights. The list of the international flights are in
    airline.internationalflights. The list of the march flights are in
    airline.marchflights.
    ▪ Each flights can be identified by data and flightnumber.
